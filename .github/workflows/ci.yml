name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lint:
    name: preflight + ansible syntax-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            openssh-client \
            ansible

      - name: Install yq (mikefarah/yq v4)
        run: |
          set -euo pipefail
          sudo curl -fsSL -o /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Install gum
        run: |
          set -euo pipefail
          tmp="$(mktemp -d)"
          cd "$tmp"
          python3 -c 'import json,re,sys,urllib.request; data=json.load(urllib.request.urlopen("https://api.github.com/repos/charmbracelet/gum/releases/latest")); url=next((a["browser_download_url"] for a in data.get("assets", []) if re.search(r"_amd64\\.deb$", a.get("name",""))), None); sys.exit("Could not discover gum amd64 deb URL from GitHub API") if not url else urllib.request.urlretrieve(url, "gum.deb")'
          sudo apt-get install -y ./gum.deb
          gum --version

      - name: Preflight
        run: bash scripts/preflight.sh

      - name: Ansible syntax check
        run: |
          set -euo pipefail
          ansible-playbook playbooks/site.yml --syntax-check
          ansible-playbook playbooks/resources.yml --syntax-check

