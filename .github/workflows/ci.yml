name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lint:
    name: preflight + ansible syntax-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            openssh-client \
            ansible

      - name: Install yq (mikefarah/yq v4)
        run: |
          set -euo pipefail
          sudo curl -fsSL -o /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Install gum
        run: |
          set -euo pipefail
          tmp="$(mktemp -d)"
          cd "$tmp"
          url="$(
            curl -fsSL https://api.github.com/repos/charmbracelet/gum/releases/latest \
              | grep -E '\"browser_download_url\"' \
              | cut -d '\"' -f4 \
              | grep -E '(linux_amd64|Linux_x86_64)\\.tar\\.gz$' \
              | head -n1
          )"
          if [ -z "${url:-}" ]; then
            echo "Could not discover gum linux_amd64 tarball URL from GitHub API" >&2
            exit 1
          fi
          curl -fsSL "$url" -o gum.tgz
          tar -xzf gum.tgz
          bin="$(find . -maxdepth 3 -type f -name gum -perm -u+x | head -n1 || true)"
          if [ -z "${bin:-}" ]; then
            echo "Could not locate gum binary in extracted tarball" >&2
            find . -maxdepth 3 -type f -print
            exit 1
          fi
          sudo install -m 0755 "$bin" /usr/local/bin/gum
          gum --version

      - name: Preflight
        run: bash scripts/preflight.sh

      - name: Ansible syntax check
        run: |
          set -euo pipefail
          ansible-playbook playbooks/site.yml --syntax-check
          ansible-playbook playbooks/resources.yml --syntax-check

